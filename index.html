<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aethra Bot ¬∑ Estudiantil (Ollama)</title>

  <!-- Preload de fondos (oscuro / claro) -->
  <link rel="preload" as="image" href="./assets/bg-dark.jpg">
  <link rel="preload" as="image" href="./assets/bg-light.jpg">

  <style>
    .line.thinking{
      font-size: 12.5px;
      color: var(--muted);
      opacity: .95;
      margin: 6px 0 10px;
    }
    /* =========================
       THEME TOKENS (Dark/Light)
       ========================= */
    :root{
      /* comunes */
      --radius: 20px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;

      /* imagen de fondo y overlay (por defecto oscuro) */
      --bg-image: url("./assets/bg-dark.jpg");
      --overlay: rgba(8,10,20,.55);

      /* dark (por defecto) */
      --text: #e6edf3;
      --muted: #c3c9d6;
      --accent: #a5b4fc;                 /* lila-azulado */
      --stroke: rgba(165,180,252,.28);

      --app-grad1: rgba(165,180,252,.22);
      --app-grad2: rgba(99,102,241,.12);
      --app-glass: rgba(30,38,70,.45);

      --bar-bg: rgba(18,24,40,.40);
      --screen-bg: #0b1220;
      --screen-inner-top: rgba(99,102,241,.10);
      --input-bg: #0a1117;
      --input-bd: #233047;
      --focus: rgba(165,180,252,.18);

      --btn-from: #a5b4fc;               /* bot√≥n */
      --btn-to:   #7aa2ff;
      --btn-text: #0b1020;

      --chip-bg: rgba(165,180,252,.92);
      --chip-text:#0c1222;
    }

    /* light overrides */
    [data-theme="light"]{
      --bg-image: url("./assets/bg-light.jpg");
      --overlay: rgba(255,255,255,.35);

      --text:#0c1220;
      --muted:#3c4a63;
      --accent:#6d83ff;
      --stroke: rgba(109,131,255,.35);

      --app-grad1: rgba(183,194,255,.28);
      --app-grad2: rgba(132,144,255,.18);
      --app-glass: rgba(255,255,255,.65);

      --bar-bg: rgba(255,255,255,.60);
      --screen-bg: #f8f9ff;
      --screen-inner-top: rgba(132,144,255,.14);
      --input-bg: #ffffff;
      --input-bd: rgba(132,144,255,.45);
      --focus: rgba(132,144,255,.28);

      --btn-from:#7aa2ff;
      --btn-to:#a5b4fc;
      --btn-text:#0b1020;

      --chip-bg: rgba(132,144,255,.92);
      --chip-text:#081226;
    }

    /* transici√≥n suave de tema */
    .theming *{ transition: color .2s ease, background .2s ease, background-color .2s ease, border-color .2s ease, box-shadow .2s ease; }
    @media (prefers-reduced-motion: reduce){ .theming *{ transition: none !important; } }

    /* =========================
       FONDO FIJO CON IMAGEN
       ========================= */
    *{ box-sizing:border-box }
    body{
      margin:0;
      position: relative;
      min-height:100svh;
      font-family: var(--font);
      color: var(--text);
      display:grid; place-items:center; padding:24px;
      /* color de respaldo por si tarda la imagen */
      background: #0b0f14;
    }
    /* Fondo fijo con overlay para legibilidad */
    body::before{
      content:"";
      position: fixed; inset: 0; z-index: -1;
      background:
        linear-gradient(var(--overlay), var(--overlay)),
        var(--bg-image) center / cover no-repeat;
    }

    /* =========================
       LAYOUT & COMPONENTES
       ========================= */
    .app{
      width:min(920px, 96vw);
      background:
        linear-gradient(160deg, var(--app-grad1), var(--app-grad2)),
        var(--app-glass);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(88,114,254,.18), 0 6px 22px rgba(0,0,0,.35);
    }

    .header{
      padding:16px 18px; display:flex; align-items:center; gap:12px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(165,180,252,.16), transparent);
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px var(--accent); }
    .title{ font-weight:800; letter-spacing:.2px; }
    .subtitle{ color:var(--muted); font-size:.9rem }

    .theme-toggle{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .chip{ font-size:12px; color:var(--chip-text); background:var(--chip-bg); border-radius:999px; padding:4px 8px; font-weight:700; }
    .tbtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke);
      background: var(--bar-bg); cursor:pointer;
    }
    .tbtn[aria-pressed="true"]{ box-shadow:0 0 0 3px var(--focus) inset; }
    svg{ width:18px; height:18px; fill: var(--text); }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .toolbar{
      display:flex; gap:10px; padding:10px 14px; align-items:center;
      border-bottom:1px solid var(--stroke);
      background:var(--bar-bg);
    }
    select{
      background:var(--input-bg); border:1px solid var(--input-bd); color:var(--text);
      border-radius:10px; padding:8px 10px; outline:none; font-size:14px;
    }

    .screen{
      height:56vh; max-height:560px; min-height:360px;
      background:var(--screen-bg);
      border-top:1px solid rgba(148,163,255,.12);
      border-bottom:1px solid rgba(148,163,255,.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      padding:18px; overflow:auto; line-height:1.5; position:relative;
      box-shadow: inset 0 0 0 1px rgba(12,26,37,.18), inset 0 12px 50px var(--screen-inner-top);
    }
    .line{ white-space:pre-wrap; margin:0 0 8px 0; }
    .line.user::before{ content:"Alumno ‚ñ∏ "; color:#9fb3c8; }
    .line.bot::before{ content:"Aethra Bot ‚ñ∏ "; color:var(--accent); text-shadow:0 0 8px rgba(165,180,252,.7); }
    .caret{ display:inline-block; width:10px; height:1.2em; background:var(--accent); margin-left:4px; transform: translateY(3px); animation:blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity:0; } }

    .footer{
      display:flex; gap:10px; padding:14px; background:var(--bar-bg);
      border-top:1px solid var(--stroke);
    }
    .input{
      flex:1; background:var(--input-bg); border:1px solid var(--input-bd); color:var(--text);
      border-radius:14px; padding:14px 16px; outline:none; font-size:15px;
      box-shadow:0 0 0 0 transparent;
    }
    .input::placeholder{ color:#99a4bc; }
    .input:focus{ border-color:#8794ff; box-shadow:0 0 0 3px var(--focus); }

    .btn{
      background:linear-gradient(180deg, var(--btn-from), var(--btn-to));
      color:var(--btn-text); border:0; border-radius:14px; padding:0 18px;
      font-weight:700; letter-spacing:.2px; cursor:pointer;
      box-shadow:0 8px 20px rgba(122,162,255,.35);
    }

    .hint{ padding:0 18px 14px 18px; color:var(--muted); font-size:12.5px }
    .error{ color:#ffb4b4 }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Aethra Bot">
    <div class="header">
      <div class="dot" aria-hidden="true"></div>
      <div>
        <div class="title">Aethra Bot</div>
        <div class="subtitle">Asistente educativo para primaria, secundaria y universidad</div>
      </div>

      <div class="theme-toggle" role="group" aria-label="Cambiar tema">
        <button id="lightBtn" class="tbtn" type="button" aria-pressed="false" title="Modo claro">
          <span class="sr-only">Modo claro</span>
          <!-- Sol -->
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 14.32l1.79 1.79 1.41-1.41-1.79-1.8-1.41 1.42zM12 4V1h-0v3zm0 19v-3h0v3zM4 12H1v0h3zm19 0h-3v0h3zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zM19.16 6.76l1.42-1.42 1.79 1.8-1.41 1.41-1.8-1.79zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
        </button>
        <button id="darkBtn" class="tbtn" type="button" aria-pressed="true" title="Modo oscuro">
          <span class="sr-only">Modo oscuro</span>
          <!-- Luna -->
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>
        </button>
        <span class="chip">OLLAMA</span>
      </div>
    </div>

    <div class="toolbar" aria-label="Controles">
      <label for="level" class="subtitle">Nivel:</label>
      <select id="level" aria-label="Nivel del estudiante">
        <option>Primaria</option>
        <option selected>Secundaria</option>
        <option>Universidad</option>
      </select>

      <label for="subject" class="subtitle">Materia:</label>
      <select id="subject" aria-label="Materia">
        <option selected>General</option>
        <option>Matem√°tica</option>
        <option>Qu√≠mica</option>
        <option>Biolog√≠a</option>
        <option>Historia</option>
        <option>Lengua</option>
        <option>Programaci√≥n</option>
      </select>
    </div>

    <div id="screen" class="screen" aria-live="polite" aria-atomic="false">
      <div class="line bot">¬°Hola! Soy <b>Aethra Bot</b>. Eleg√≠ tu nivel y materia, escrib√≠ tu duda y te explico paso a paso.</div>
    </div>

    <form id="chat-form" class="footer" autocomplete="off">
      <input id="prompt" class="input" name="prompt" placeholder="Ej.: ¬øC√≥mo factorizar un trinomio?" aria-label="Escribir mensaje" />
      <button class="btn" type="submit">Enviar</button>
    </form>

    <div class="hint">Consejo: Enter = enviar ¬∑ Shift + Enter = salto de l√≠nea.</div>
  </div>

  <script>
    // ======= THEME SETUP =======
    const root = document.documentElement;
    const lightBtn = document.getElementById('lightBtn');
    const darkBtn  = document.getElementById('darkBtn');

    function applyTheme(theme){
      // transici√≥n suave
      root.classList.add('theming');
      root.setAttribute('data-theme', theme);
      // toggle visual
      lightBtn.setAttribute('aria-pressed', theme === 'light');
      darkBtn .setAttribute('aria-pressed', theme === 'dark');
      // persistencia
      try{ localStorage.setItem('theme', theme); }catch(e){}
      // quitar clase de transici√≥n
      setTimeout(()=>root.classList.remove('theming'), 200);
    }

    // preferencia previa o del sistema
    (function initTheme(){
      let t = null;
      try{ t = localStorage.getItem('theme'); }catch(e){}
      if(!t){
        t = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      }
      applyTheme(t);

      // Preload del fondo del tema opuesto para evitar parpadeo en el cambio
      const opposite = t === 'light' ? './assets/bg-dark.jpg' : './assets/bg-light.jpg';
      const i = new Image(); i.src = opposite;
    })();

    lightBtn.addEventListener('click', ()=>applyTheme('light'));
    darkBtn .addEventListener('click', ()=>applyTheme('dark'));

    // ======= CHAT LOGIC =======
    const screenEl = document.getElementById('screen');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('prompt');
    const levelSel = document.getElementById('level');
    const subjectSel = document.getElementById('subject');
    const history = [];
    let thinkingEl = null, thinkingTimer = null;

    function showThinking(){
      clearThinking();
      thinkingEl = document.createElement('div');
      thinkingEl.className = 'line thinking';
      thinkingEl.textContent = 'Aethra Bot est√° pensando';
      screenEl.appendChild(thinkingEl);

      // animaci√≥n simple de puntitos con JS
      let i = 0;
      thinkingTimer = setInterval(() => {
        i = (i + 1) % 4;
        thinkingEl.textContent = 'Aethra Bot est√° pensando' + '.'.repeat(i);
        screenEl.scrollTop = screenEl.scrollHeight;
      }, 350);
    }

    function clearThinking(){
      if (thinkingTimer) { clearInterval(thinkingTimer); thinkingTimer = null; }
      if (thinkingEl && thinkingEl.parentNode) thinkingEl.remove();
      thinkingEl = null;
    }
  </script>
  <script>
    // Enter = enviar; Shift+Enter = nueva l√≠nea
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); form.requestSubmit(); }
    });

  form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (input.value || '').trim();
      if (!text) return;
      input.value = '';
      addLine(text, 'user');

    try {
        showThinking(); // ‚üµ muestra "pensando..."
        const reply = await sendToBackend(text, {
          level: levelSel.value,
          subject: subjectSel.value
        });
        clearThinking(); // ‚üµ oculta al llegar la respuesta
        await typeLine(reply, 'bot');
    } catch (err) {
        console.error(err);
        clearThinking(); // ‚üµ oculta tambi√©n si falla
        addLine("‚ö†Ô∏è No pude hablar con el backend. ¬øArrancaste `npm start` y Ollama est√° activo en 11434?", 'bot error');
    }
      screenEl.scrollTop = screenEl.scrollHeight;
    
  });

    function addLine(text, who) {
      const div = document.createElement('div');
      div.className = 'line ' + who;
      div.textContent = text;
      screenEl.appendChild(div);
      screenEl.scrollTop = screenEl.scrollHeight;
    }

    async function typeLine(text, who='bot', cps=28) {
      const div = document.createElement('div');
      div.className = 'line ' + who;
      screenEl.appendChild(div);
      let i = 0, dt = Math.max(10, 1000 / cps);
      while (i < text.length) {
        div.textContent = text.slice(0, ++i);
        await new Promise(r => setTimeout(r, dt));
        screenEl.scrollTop = screenEl.scrollHeight;
      }
    }

    async function sendToBackend(text, context) {
    history.push({ role:"user", content:text });
    // üî™ quedate con los √∫ltimos 12 mensajes (6 ida y vuelta)
    if (history.length > 12) history.splice(0, history.length - 12);

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, history, context })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    history.push({ role:"assistant", content:data.reply });
    return data.reply;
  }
  </script>
</body>
</html>
